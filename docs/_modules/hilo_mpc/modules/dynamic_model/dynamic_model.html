

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>hilo_mpc.modules.dynamic_model.dynamic_model &mdash; HILO-MPC 1.0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="../../../../about.html"/>
        <link rel="index" title="Index"
              href="../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../search.html"/>
    <link rel="top" title="HILO-MPC 1.0.1 documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> HILO-MPC
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption" role="heading"><span class="caption-text">Quick start:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../citation.html">Citing HILO-MPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about.html">About</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/nmpc_hybrid_bio.html">Learning Supported MPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/mhe_chemical_reaction.html">Moving Horizon Estimator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/mpc_formula1.html">Formula 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/mpc_pendulum.html">Inverted pendulum - DAE System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/path_following_mpc.html">Path following vs Trajectory Tracking MPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/CSTR_Example.html">CSTR Reactor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/learn_mpc.html">Learning an MPC controller with a NN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/mhe_helicopter_example.html">CE 150 Helicopter</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/controllers.html">Control module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/machinelearnings.html">Machine learning module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/modellings.html">Modelling module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/estimators.html">Observer module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/controllers.html">Controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/learning.html">Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modelling.html">Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/estimators.html">Observers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">HILO-MPC</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>hilo_mpc.modules.dynamic_model.dynamic_model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for hilo_mpc.modules.dynamic_model.dynamic_model</h1><div class="highlight"><pre>
<span></span><span class="c1">#   </span>
<span class="c1">#   This file is part of HILO-MPC</span>
<span class="c1">#</span>
<span class="c1">#   HILO-MPC is a toolbox for easy, flexible and fast development of machine-learning-supported</span>
<span class="c1">#   optimal control and estimation problems</span>
<span class="c1">#</span>
<span class="c1">#   Copyright (c) 2021 Johannes Pohlodek, Bruno Morabito, Rolf Findeisen</span>
<span class="c1">#                      All rights reserved</span>
<span class="c1">#</span>
<span class="c1">#   HILO-MPC is free software: you can redistribute it and/or modify</span>
<span class="c1">#   it under the terms of the GNU Lesser General Public License as</span>
<span class="c1">#   published by the Free Software Foundation, either version 3</span>
<span class="c1">#   of the License, or (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#   HILO-MPC is distributed in the hope that it will be useful,</span>
<span class="c1">#   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1">#   GNU Lesser General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#   You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1">#   along with HILO-MPC. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">casadi</span> <span class="k">as</span> <span class="nn">ca</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">..base</span> <span class="kn">import</span> <span class="n">Base</span><span class="p">,</span> <span class="n">Vector</span><span class="p">,</span> <span class="n">Equations</span><span class="p">,</span> <span class="n">RightHandSide</span><span class="p">,</span> <span class="n">TimeSeries</span>
<span class="kn">from</span> <span class="nn">..machine_learning.base</span> <span class="kn">import</span> <span class="n">LearningBase</span>
<span class="kn">from</span> <span class="nn">...util.data</span> <span class="kn">import</span> <span class="n">DataSet</span><span class="p">,</span> <span class="n">DataGenerator</span>
<span class="kn">from</span> <span class="nn">...util.modeling</span> <span class="kn">import</span> <span class="n">GenericCost</span><span class="p">,</span> <span class="n">QuadraticCost</span><span class="p">,</span> <span class="n">continuous2discrete</span>
<span class="kn">from</span> <span class="nn">...util.parsing</span> <span class="kn">import</span> <span class="n">parse_dynamic_equations</span>
<span class="kn">from</span> <span class="nn">...util.util</span> <span class="kn">import</span> <span class="n">check_if_list_of_string</span><span class="p">,</span> <span class="n">convert</span><span class="p">,</span> <span class="n">dump_clean</span><span class="p">,</span> <span class="n">generate_c_code</span><span class="p">,</span> <span class="n">is_iterable</span><span class="p">,</span> <span class="n">is_list_like</span><span class="p">,</span> \
    <span class="n">is_square</span><span class="p">,</span> <span class="n">who_am_i</span><span class="p">,</span> <span class="n">JIT</span>

<span class="n">Symbolic</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;Symbolic&#39;</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">)</span>
<span class="n">Mod</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;Mod&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;_Model&#39;</span><span class="p">)</span>
<span class="n">Numeric</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<span class="n">NumArray</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Numeric</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
<span class="n">ArrayLike</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">NumArray</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">,</span> <span class="n">Vector</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_Model</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">discrete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">solver</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">solver_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">time_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span>
            <span class="n">use_sx</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor method&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_id</span><span class="p">()</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

        <span class="k">if</span> <span class="n">solver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">discrete</span><span class="p">:</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;cvodes&#39;</span>
        <span class="k">elif</span> <span class="n">discrete</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">solver_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">solver_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span> <span class="o">=</span> <span class="n">solver_options</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_integrator_function</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meas_function</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_g0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_linearization_about_trajectory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_time_variant</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span> <span class="o">=</span> <span class="n">use_sx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_empty_model</span><span class="p">(</span><span class="n">time_unit</span><span class="p">,</span> <span class="n">discrete</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_dimensions</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Addition method&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">+=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incremental addition method&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_learned</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtraction method&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">-=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="fm">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incremental subtraction method&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_learned</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiplication method&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">*=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="fm">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incremental multiplication method&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_learned</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True division method&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">/=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="fm">__itruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incremental true division method&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_learned</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;State getter method&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Test this</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Remove unpicklable entries</span>
        <span class="c1"># del state[&#39;&#39;]</span>
        <span class="c1"># or make them picklable</span>
        <span class="c1"># state[&#39;&#39;] = []</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;State setter method&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Test this</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;_t&#39;</span><span class="p">,</span> <span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;_y&#39;</span><span class="p">,</span> <span class="s1">&#39;_z&#39;</span><span class="p">,</span> <span class="s1">&#39;_u&#39;</span><span class="p">,</span> <span class="s1">&#39;_p&#39;</span><span class="p">,</span> <span class="s1">&#39;_rhs&#39;</span><span class="p">,</span> <span class="s1">&#39;_quad&#39;</span><span class="p">,</span> <span class="s1">&#39;_x_eq&#39;</span><span class="p">,</span> <span class="s1">&#39;_u_eq&#39;</span><span class="p">,</span> <span class="s1">&#39;_x_col&#39;</span><span class="p">,</span> <span class="s1">&#39;_z_col&#39;</span><span class="p">]:</span>
            <span class="n">pointer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">pointer</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Representation method&quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;id=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, name=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, discrete=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, solver=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, solver_options=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, time_unit=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, use_sx=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Item iteration method&quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_empty_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">,</span> <span class="n">discrete</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param time_unit:</span>
<span class="sd">        :param discrete:</span>
<span class="sd">        :param prefix:</span>
<span class="sd">        :param suffix:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fx</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span> <span class="k">else</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="n">values_or_names</span><span class="o">=</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;time...&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time_unit</span><span class="p">,</span>
                          <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;sampling_time&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;sampling_time&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_t</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="n">values_or_names</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;time...&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time_unit</span><span class="p">,</span>
                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;time&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_unit</span> <span class="o">=</span> <span class="n">time_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;dynamical_states&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;dynamical_states&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span>
                         <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;equilibrium_point_dynamical_states&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;equilibrium_point_dynamical_states&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;collocation_points_dynamical_states&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span>
                             <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;collocation_points_dynamical_states&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;measurements&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;measurements&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;algebraic_states&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;algebraic_states&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span>
                         <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;equilibrium_point_algebraic_states&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;equilibrium_point_algebraic_states&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;collocation_points_algebraic_states&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span>
                             <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;collocation_points_algebraic_states&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_u</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;inputs&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;equilibrium_point_inputs&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;equilibrium_point_inputs&#39;</span><span class="p">,</span>
                            <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;parameters&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span> <span class="o">=</span> <span class="n">RightHandSide</span><span class="p">(</span><span class="n">discrete</span><span class="o">=</span><span class="n">discrete</span><span class="p">,</span> <span class="n">use_sx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span> <span class="o">=</span> <span class="n">fx</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_linearity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_linear</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">,</span> <span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="s1">&#39;meas&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;_y&#39;</span><span class="p">,</span> <span class="s1">&#39;_z&#39;</span><span class="p">,</span> <span class="s1">&#39;_u&#39;</span><span class="p">]:</span>  <span class="c1"># &#39;_p&#39;</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
                    <span class="n">is_linear</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">is_linear</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">,</span> <span class="n">eq</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_linear</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_linear</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span> <span class="o">=</span> <span class="n">is_linear</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_check_time_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_time_variant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_time_variant</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="p">,</span> <span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="o">.</span><span class="n">numel_out</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="p">,</span> <span class="p">(</span><span class="n">GenericCost</span><span class="p">,</span> <span class="n">QuadraticCost</span><span class="p">)):</span>
            <span class="c1"># TODO: Maybe we could add a __len__ dunder method to the cost classes, that would wrap this behavior</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_q</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Handle options in case of solver switches</span>
        <span class="c1"># TODO: Solver could also be the interface to a solver</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ca</span><span class="o">.</span><span class="n">has_integrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">==</span> <span class="s1">&#39;cvodes&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solver &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="si">}</span><span class="s2">&#39; is not suitable for DAE systems. Switching to &#39;idas&#39;...&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="s1">&#39;idas&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solver &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="si">}</span><span class="s2">&#39; is not available on your system. Switching to &#39;cvodes&#39;...&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="s1">&#39;cvodes&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solver &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="si">}</span><span class="s2">&#39; is not available on your system. Switching to &#39;idas&#39;...&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="s1">&#39;idas&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="s1">&#39;cvodes&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="s1">&#39;idas&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_parse_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equations</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param equations:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;discrete&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="p">,</span>
            <span class="s1">&#39;use_sx&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span><span class="p">,</span>
            <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">elements</span><span class="p">(),</span>
            <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">elements</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">var</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">elements</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">var</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">elements</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">var</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">elements</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">var</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">elements</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">var</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">elements</span><span class="p">()</span>

        <span class="n">dae</span> <span class="o">=</span> <span class="n">parse_dynamic_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="o">**</span><span class="n">var</span><span class="p">)</span>

        <span class="n">description</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">)</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">)</span>

        <span class="n">vec</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vec</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">vec</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">y</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">vec</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">z</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">vec</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">u</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">vec</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">quad</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;quad&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quad</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span> <span class="o">=</span> <span class="n">quad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">dae</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dae</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_solver</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_unpack_state_space</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span>
        <span class="n">n_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span>
        <span class="n">n_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span>
        <span class="n">n_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span>

        <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># NOTE: This check is redundant, since it will already be checked during setting of the matrix whether E is</span>
            <span class="c1">#  a square matrix</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_square</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Supplied mass matrix (M) needs to be a square matrix. Either supply a square matrix &quot;</span>
                                 <span class="s2">&quot;or the entries of the diagonal as an array-like.&quot;</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">m_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">m_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">M</span><span class="p">[</span><span class="n">m_x</span><span class="p">,</span> <span class="n">m_x</span><span class="p">]</span> <span class="o">/=</span> <span class="n">m</span><span class="p">[</span><span class="n">m_x</span><span class="p">]</span>  <span class="c1"># Normalize</span>
            <span class="n">M_inv</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">M_inv</span><span class="p">[</span><span class="n">m_x</span><span class="p">,</span> <span class="n">m_x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">M_inv</span><span class="p">[</span><span class="n">m_z</span><span class="p">,</span> <span class="n">m_z</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">n_x</span> <span class="o">=</span> <span class="n">m_x</span><span class="o">.</span><span class="n">size</span>
            <span class="n">n_z</span> <span class="o">=</span> <span class="n">m_z</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">!=</span> <span class="n">n_x</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied mass matrix (M) has </span><span class="si">{</span><span class="n">n_x</span><span class="si">}</span><span class="s2"> non-zero elements on its &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;diagonal (i.e. dynamical states), but the number of set dynamical states is &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">!=</span> <span class="n">n_z</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied mass matrix (M) has </span><span class="si">{</span><span class="n">n_z</span><span class="si">}</span><span class="s2"> zero elements on its diagonal&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot; (i.e. algebraic states), but the number of set algebraic states is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_x</span> <span class="o">+</span> <span class="n">n_z</span><span class="p">,</span> <span class="n">n_x</span> <span class="o">+</span> <span class="n">n_z</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch in state matrix (A). Supplied dimension is &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="n">n_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_z</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">n_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_z</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">n_x</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">n_z</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">n_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_x</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch in state matrix (A). Supplied dimension is &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="n">n_x</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">n_x</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># NOTE: This could happen, if mass matrix (M) was an identity matrix, i.e. no algebraic states</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">n_x</span><span class="p">)</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">n_z</span><span class="p">)</span>  <span class="c1"># n_z is 0 here</span>
            <span class="k">elif</span> <span class="n">n_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Only algebraic equations were supplied for the DAE system. ODE&#39;s are still missing.&quot;</span>
                                   <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_x</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">n_x</span><span class="p">)</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">n_z</span><span class="p">)</span>  <span class="c1"># n_z is 0 here</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_x</span> <span class="o">+</span> <span class="n">n_z</span><span class="p">,</span> <span class="n">n_x</span> <span class="o">+</span> <span class="n">n_z</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span>
        <span class="n">xz</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">n_x</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_z</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">M_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">n_x</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_z</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
            <span class="n">m_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_x</span><span class="p">)</span>
            <span class="n">m_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_z</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_x</span>

        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_u</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_u</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span>
                <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">n_u</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_x</span> <span class="o">+</span> <span class="n">n_z</span><span class="p">,</span> <span class="n">n_u</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch in input matrix (B). Supplied dimension is &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="n">n_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_z</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">n_u</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_x</span> <span class="o">+</span> <span class="n">n_z</span><span class="p">,</span> <span class="n">n_u</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_y</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">n_y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_y</span><span class="p">,</span> <span class="n">n_x</span> <span class="o">+</span> <span class="n">n_z</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch in output matrix (C). Supplied dimension is &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="n">n_y</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">n_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_z</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_y</span><span class="p">,</span> <span class="n">n_x</span> <span class="o">+</span> <span class="n">n_z</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">values</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_y</span><span class="p">,</span> <span class="n">n_u</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch in feedthrough matrix (D). Supplied dimension is &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="n">n_y</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">n_u</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_y</span><span class="p">,</span> <span class="n">n_u</span><span class="p">)</span>

        <span class="n">fg</span> <span class="o">=</span> <span class="n">a</span> <span class="o">@</span> <span class="n">xz</span> <span class="o">+</span> <span class="n">b</span> <span class="o">@</span> <span class="n">u</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">m_x</span><span class="p">,</span> <span class="p">:]</span> <span class="o">@</span> <span class="n">fg</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span><span class="p">[</span><span class="n">m_x</span><span class="p">]</span>  <span class="c1"># scale back</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">M_inv</span><span class="p">[</span><span class="n">m_z</span><span class="p">,</span> <span class="p">:]</span> <span class="o">@</span> <span class="n">fg</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">c</span> <span class="o">@</span> <span class="n">xz</span> <span class="o">+</span> <span class="n">d</span> <span class="o">@</span> <span class="n">u</span>

        <span class="n">function</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">],</span>
                               <span class="p">{</span><span class="s2">&quot;allow_free&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="o">.</span><span class="n">get_free</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">_append_learned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learned</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Equations</span><span class="p">,</span> <span class="n">LearningBase</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">LearningBase</span><span class="p">]],</span> <span class="n">sign</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param learned:</span>
<span class="sd">        :param sign:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">learned</span><span class="p">,</span> <span class="n">LearningBase</span><span class="p">):</span>
            <span class="c1"># if self._slice is None:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">!=</span> <span class="n">learned</span><span class="o">.</span><span class="n">n_labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension is </span><span class="si">{</span><span class="n">learned</span><span class="o">.</span><span class="n">n_labels</span><span class="si">}</span><span class="s2">x1, but required &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="si">}</span><span class="s2">x1.&quot;</span><span class="p">)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     if len(self._slice) != learned.n_labels:</span>
            <span class="c1">#         raise</span>
            <span class="n">dyn_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">ode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">learned</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
                <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">param</span>
                <span class="k">elif</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">param</span>
                <span class="k">elif</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*=</span> <span class="n">param</span>
                <span class="k">elif</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="n">param</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_iterable</span><span class="p">(</span><span class="n">learned</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">learned</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">learned</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">learned</span><span class="p">)</span><span class="si">}</span><span class="s2">x1, but required dimension &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="si">}</span><span class="s2">x1.&quot;</span><span class="p">)</span>
            <span class="n">dyn_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">ode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">learn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">learned</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">learn</span><span class="p">,</span> <span class="n">LearningBase</span><span class="p">):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">labels</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Expected dimension 1x1, got dimension </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="si">}</span><span class="s2">x1.&quot;</span><span class="p">)</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">learn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">learn</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> for operations on the model instance.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">param</span>
                <span class="k">elif</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">param</span>
                <span class="k">elif</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*=</span> <span class="n">param</span>
                <span class="k">elif</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="n">param</span>
            <span class="n">learned</span> <span class="o">=</span> <span class="p">[</span><span class="n">learn</span> <span class="k">for</span> <span class="n">learn</span> <span class="ow">in</span> <span class="n">learned</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">learn</span><span class="p">,</span> <span class="n">LearningBase</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">learned</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
            <span class="n">n_out</span> <span class="o">=</span> <span class="n">learned</span><span class="o">.</span><span class="n">numel_out</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">!=</span> <span class="n">n_out</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension is </span><span class="si">{</span><span class="n">n_out</span><span class="si">}</span><span class="s2">x1, but required dimension is &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="si">}</span><span class="s2">x1.&quot;</span><span class="p">)</span>
            <span class="n">dyn_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">ode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_out</span><span class="p">):</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;p&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">param</span>
                <span class="k">elif</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">param</span>
                <span class="k">elif</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*=</span> <span class="n">param</span>
                <span class="k">elif</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                    <span class="n">dyn_eq</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="n">param</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">learned</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">learned</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">learned</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ode</span> <span class="o">=</span> <span class="n">dyn_eq</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="p">]</span>
        <span class="n">alg</span> <span class="o">=</span> <span class="n">dyn_eq</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="p">:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_parameters</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ode</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ode</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">alg</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;alg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_equations</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">substitute_from</span><span class="p">(</span><span class="n">learned</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_sx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param use_sx:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_sx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_sx</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">use_sx</span><span class="p">:</span>
            <span class="c1"># NOTE: At the moment it is assumed, that the quadrature function is empty</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">y</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">y</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
        <span class="n">variables</span><span class="p">,</span> <span class="n">equations</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">check_quadrature_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
            <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="n">variables</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="n">variables</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="n">variables</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
            <span class="s1">&#39;ode&#39;</span><span class="p">:</span> <span class="n">equations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;alg&#39;</span><span class="p">:</span> <span class="n">equations</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;meas&#39;</span><span class="p">:</span> <span class="n">equations</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s1">&#39;quad&#39;</span><span class="p">:</span> <span class="n">equations</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="n">x_eq</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">z_eq</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">u_eq</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">x_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;x_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_eq</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">z_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;z_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_eq</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">u_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;u_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_eq</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_sx</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">values</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create model from dict</span>

<span class="sd">        :param arg:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># should always be a list of one entry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dynamical_states</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dynamical_equations</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_algebraic_states</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_algebraic_equations</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;alg&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_measurements</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_measurement_equations</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;meas&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_quadrature_function</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;quad&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;display&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="s1">&#39;display&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;linearized&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="s1">&#39;linearized&#39;</span><span class="p">]</span>
            <span class="n">trj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linearized&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">trj</span> <span class="o">==</span> <span class="s1">&#39;trajectory&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_linearization_about_trajectory</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;f0&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f0</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;g0&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_g0</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">]</span>
        <span class="c1"># self.discrete = arg[&#39;discrete&#39;]</span>
        <span class="c1"># self.set_quadrature_functions(arg[&#39;quad&#39;])</span>
        <span class="k">if</span> <span class="s1">&#39;x_eq&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;x_eq&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;x_eq&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;z_eq&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;z_eq&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z_eq&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;u_eq&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;u_eq&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;u_eq&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;X&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Z&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Time variable of the model</span>

<span class="sd">        :returns: Time variable of the model as a symbolic expression</span>
<span class="sd">        :rtype: :py:class:`casadi.casadi.SX` | :py:class:`casadi.casadi.MX`</span>
<span class="sd">        :alias: :py:attr:`~hilo_mpc.core.model.Model.t`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">values</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sampling_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sampling time variable of the model</span>

<span class="sd">        :return: Sampling time variable of the model as a symbolic expression</span>
<span class="sd">        :rtype: :py:class:`casadi.casadi.SX` | :py:class:`casadi.casadi.MX`</span>
<span class="sd">        :alias: :py:attr:`~hilo_mpc.core.model.Model.dt`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">values</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="n">sampling_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Time unit of the model</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_unit</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamical_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Differential state vector of the model</span>

<span class="sd">        :return: Differential state vector of the model as a symbolic expression</span>
<span class="sd">        :rtype: :py:class:`casadi.casadi.SX` | :py:class:`casadi.casadi.MX`</span>
<span class="sd">        :alias: :py:attr:`~hilo_mpc.core.model.Model.x`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># @dynamical_states.setter</span>
    <span class="k">def</span> <span class="nf">set_dynamical_states</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the dynamical state vector of the model</span>

<span class="sd">        :param args: Possible combinations of how to supply arguments to this method can be taken from the table</span>
<span class="sd">        :type args:</span>
<span class="sd">        :param description: Description of the single elements of the dynamical state vector. If only a single</span>
<span class="sd">            description is supplied, but the vector has a dimension higher than 1, it is assumed that all the elements</span>
<span class="sd">            of the vector have the same description. This is just for convenience, since the information stored in the</span>
<span class="sd">            description will not be used anywhere else.</span>
<span class="sd">        :type description: str, sequence of str, optional</span>
<span class="sd">        :param labels: Labels of the single elements of the dynamical state vector. If only a single label is</span>
<span class="sd">            supplied, but the vector has a dimension higher than 1, it is assumed that all the elements of the vector</span>
<span class="sd">            have the same label. At the moment the label information is only used for automatically generating the</span>
<span class="sd">            y-axis labels for the plotting functionality.</span>
<span class="sd">        :type labels: str, sequence of str, optional</span>
<span class="sd">        :param units: Units of the single elements of the dynamical state vector. If only a single unit is supplied,</span>
<span class="sd">            but the vector has a dimension higher than 1, it is assumed that all the elements of the vector have the</span>
<span class="sd">            same unit. At the moment the unit information is only used for automatically generating the y-axis labels</span>
<span class="sd">            for the plotting functionality.</span>
<span class="sd">        :type units: str, sequence of str, optional</span>
<span class="sd">        :param kwargs: Additional keyword arguments, see table</span>
<span class="sd">        :type kwargs: str, optional</span>
<span class="sd">        :return: Differential state vector of the model as a symbolic expression</span>
<span class="sd">        :rtype: :py:class:`casadi.casadi.SX` | :py:class:`casadi.casadi.MX`</span>

<span class="sd">        ============================================= ==============================</span>
<span class="sd">        args                                          kwargs</span>
<span class="sd">        ============================================= ==============================</span>
<span class="sd">        list of each state variable (sequence of str) --</span>
<span class="sd">        dimension of state vector (int)               **name** of state vector (str)</span>
<span class="sd">        ============================================= ==============================</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Use overload here (from typing library) see https://stackoverflow.com/a/45869067</span>
        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>

        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>

        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">dynamical_states</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">values</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamical_state_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamical_state_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">units</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamical_state_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">labels</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamical_state_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_x</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">measurements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># @measurements.setter</span>
    <span class="k">def</span> <span class="nf">set_measurements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Use overload here (from typing library) see https://stackoverflow.com/a/45869067</span>
        <span class="n">keep_refs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep_refs&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keep_refs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keep_refs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;labels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_refs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Vector</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: SX/MX check</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_dimensions</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">values</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">measurements</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">measurement_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">measurement_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">units</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">measurement_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">labels</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">measurement_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_y</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">algebraic_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># @algebraic_states.setter</span>
    <span class="k">def</span> <span class="nf">set_algebraic_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Use overload here (from typing library) see https://stackoverflow.com/a/45869067</span>
        <span class="n">keep_refs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep_refs&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keep_refs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keep_refs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;labels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_refs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Vector</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: SX/MX check</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_dimensions</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_solver</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">algebraic_states</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">z_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">values</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">algebraic_state_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">algebraic_state_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">units</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">algebraic_state_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">labels</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">algebraic_state_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_z</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># @inputs.setter</span>
    <span class="k">def</span> <span class="nf">set_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Use overload here (from typing library) see https://stackoverflow.com/a/45869067</span>
        <span class="n">keep_refs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep_refs&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keep_refs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keep_refs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;labels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_refs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Vector</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;u&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: SX/MX check</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_u</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_dimensions</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">inputs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">u_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">values</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">units</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">labels</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_u</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># @parameters.setter</span>
    <span class="k">def</span> <span class="nf">set_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Use overload here (from typing library) see https://stackoverflow.com/a/45869067</span>
        <span class="n">keep_refs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep_refs&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keep_refs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keep_refs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;labels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_refs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Vector</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;p&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: SX/MX check</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_dimensions</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">parameters</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameter_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameter_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">units</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameter_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">labels</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameter_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_p</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamical_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">ode</span>

    <span class="c1"># @dynamical_equations.setter</span>
    <span class="k">def</span> <span class="nf">set_dynamical_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param arg:</span>
<span class="sd">        :param delimiter:</span>
<span class="sd">        :param check_properties:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong type of arguments for function </span><span class="si">{</span><span class="n">who_am_i</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># TODO: What if string is a path to a file</span>
            <span class="k">if</span> <span class="n">delimiter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span><span class="p">:</span>
                    <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
                    <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Parsing from string not supported for operating system </span><span class="si">{</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">equations</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch between supplied dynamical equations (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;dynamical states (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
                <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;d</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">(t)/dt=&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">equations</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">(k+1)=&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">equations</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">))</span> <span class="ow">and</span> <span class="n">check_if_list_of_string</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch between supplied dynamical equations (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="si">}</span><span class="s2">) and dynamical &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;states (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
                <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;d</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">(t)/dt=&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arg</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">(k+1)=&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arg</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;ode&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">ode</span> <span class="o">=</span> <span class="n">dynamical_equations</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">measurement_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">meas</span>

    <span class="c1"># @measurement_equations.setter</span>
    <span class="k">def</span> <span class="nf">set_measurement_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param arg:</span>
<span class="sd">        :param delimiter:</span>
<span class="sd">        :param check_properties:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong type of arguments for function </span><span class="si">{</span><span class="n">who_am_i</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># TODO: What if string is a path to a file</span>
            <span class="k">if</span> <span class="n">delimiter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span><span class="p">:</span>
                    <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
                    <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Parsing from string not supported for operating system </span><span class="si">{</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">equations</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch between supplied measurement equations (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;measurements (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_measurements</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">equations</span><span class="p">))</span>
            <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">(k)=&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">equations</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">))</span> <span class="ow">and</span> <span class="n">check_if_list_of_string</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch between supplied measurement equations (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;measurements (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_measurements</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
            <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">(k)=&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arg</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;meas&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_measurements</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">size1</span><span class="p">())</span>

    <span class="n">meas</span> <span class="o">=</span> <span class="n">measurement_equations</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">algebraic_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbolic</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span>

    <span class="c1"># @algebraic_equations.setter</span>
    <span class="k">def</span> <span class="nf">set_algebraic_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param arg:</span>
<span class="sd">        :param delimiter:</span>
<span class="sd">        :param check_properties:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong type of arguments for function </span><span class="si">{</span><span class="n">who_am_i</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># TODO: What if string is a path to a file</span>
            <span class="k">if</span> <span class="n">delimiter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span><span class="p">:</span>
                    <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
                    <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Parsing from string not supported for operating system </span><span class="si">{</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">equations</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch between supplied algebraic equations (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span><span class="si">}</span><span class="s2">) and &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;algebraic states (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;0=&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">equations</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">))</span> <span class="ow">and</span> <span class="n">check_if_list_of_string</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch between supplied algebraic equations (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="si">}</span><span class="s2">) and algebraic &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;states (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;0=&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_solver</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">check_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">alg</span> <span class="o">=</span> <span class="n">algebraic_equations</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">quadrature_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span>

    <span class="c1"># @quadrature_function.setter</span>
    <span class="k">def</span> <span class="nf">set_quadrature_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param arg:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong type of arguments for function </span><span class="si">{</span><span class="n">who_am_i</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
                <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;int=</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sum=</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
            <span class="n">all_the_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_the_names</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name_in</span><span class="p">()))</span> <span class="o">==</span> <span class="n">arg</span><span class="o">.</span><span class="n">n_in</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">not_in_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">name_in</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_the_names</span><span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The following arguments to the supplied function are not variables of the model: &quot;</span> \
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">not_in_model</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>  <span class="c1"># TODO: Which error makes the most sense here? RuntimeError?</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">GenericCost</span><span class="p">,</span> <span class="n">QuadraticCost</span><span class="p">)):</span>
            <span class="c1"># TODO: We probably need some further checks here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;quad&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_dimensions</span><span class="p">()</span>
        <span class="c1"># self._n_q = self._quad.size1()</span>
        <span class="c1"># self.check_consistency()</span>

    <span class="n">quad</span> <span class="o">=</span> <span class="n">quadrature_function</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_q</span>

    <span class="k">def</span> <span class="nf">set_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param equations:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: See add_equations()</span>
        <span class="c1"># TODO: What about keep_refs?</span>
        <span class="n">ode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">alg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">quad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quad&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">meas</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;meas&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">equations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">RightHandSide</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="s1">&#39;rhs&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;alg&#39;</span> <span class="ow">in</span> <span class="n">equations</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_solver</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">equations</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equations</span><span class="p">(</span><span class="n">equations</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># What now?</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Input not recognized. No changes applied.&quot;</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># TODO: What if string is a path to a file</span>
                <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equations</span><span class="p">(</span><span class="n">equations</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_equations</span><span class="p">(</span><span class="n">equations</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Parsing from string not supported for operating system </span><span class="si">{</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_dynamical_equations</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_algebraic_equations</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">quad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_quadrature_function</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">meas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_measurement_equations</span><span class="p">(</span><span class="n">meas</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">matrix_notation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">generate_matrix_notation</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">matrix_notation</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@state_matrix</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">state_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_square</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The state matrix needs to be a square matrix. Supplied matrix has dimensions &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">system_matrix</span> <span class="o">=</span> <span class="n">state_matrix</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">state_matrix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">matrix_notation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">generate_matrix_notation</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">matrix_notation</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@input_matrix</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">input_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">input_matrix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">matrix_notation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">generate_matrix_notation</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">matrix_notation</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@output_matrix</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">output_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">C</span> <span class="o">=</span> <span class="n">output_matrix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">feedthrough_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">matrix_notation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">generate_matrix_notation</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">matrix_notation</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@feedthrough_matrix</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">feedthrough_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">feedforward_matrix</span> <span class="o">=</span> <span class="n">feedthrough_matrix</span>

    <span class="n">D</span> <span class="o">=</span> <span class="n">feedthrough_matrix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mass_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@mass_matrix</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mass_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_square</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The mass matrix (M) needs to be a square matrix. Supplied matrix has dimensions &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">mass_matrix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">discrete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span>

    <span class="nd">@discrete</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">discrete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span> <span class="o">=</span> <span class="n">boolean</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">continuous</span>

    <span class="nd">@continuous</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">continuous</span> <span class="o">=</span> <span class="n">boolean</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span>

    <span class="nd">@solver</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># TODO: Check which solver options can be used for multiple solvers and keep them</span>
        <span class="c1"># TODO: Solver could also be the interface to a solver</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_solver</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="n">arg</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solver options have been reset&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solver not updated&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Solver type must be a string&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dump_clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_dynamical_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param states:</span>
<span class="sd">        :param position:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add support for description, labels and units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">add_measurements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measurements</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param measurements:</span>
<span class="sd">        :param position:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add support for description, labels and units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">measurements</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">add_algebraic_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param states:</span>
<span class="sd">        :param position:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add support for description, labels and units</span>
        <span class="c1"># TODO: Add self._update_solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">add_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param inputs:</span>
<span class="sd">        :param position:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add support for description, labels and units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">add_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param parameters:</span>
<span class="sd">        :param position:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add support for description, labels and units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">add_dynamical_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equations</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param equations:</span>
<span class="sd">        :param position:</span>
<span class="sd">        :param check_properties:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;ode&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">add_algebraic_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equations</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param equations:</span>
<span class="sd">        :param position:</span>
<span class="sd">        :param check_properties:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add self._update_solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">add_quadrature_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">functions</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param functions:</span>
<span class="sd">        :param position:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;quad&#39;</span><span class="p">,</span> <span class="n">functions</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_measurement_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equations</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param equations:</span>
<span class="sd">        :param position:</span>
<span class="sd">        :param check_properties:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="s1">&#39;meas&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">add_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param equations:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: Right now, if the &#39;equations&#39; argument is given, the arguments &#39;ode&#39;, &#39;alg&#39;, &#39;quad&#39; and &#39;meas&#39; will be</span>
        <span class="c1"># overwritten.</span>
        <span class="c1"># TODO: Arguments that are not part of the &#39;equations&#39; dict should not be overwritten (see NOTE above)</span>
        <span class="k">if</span> <span class="n">equations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="n">RightHandSide</span><span class="p">):</span>
                <span class="n">ode</span> <span class="o">=</span> <span class="n">equations</span><span class="o">.</span><span class="n">ode</span>
                <span class="n">alg</span> <span class="o">=</span> <span class="n">equations</span><span class="o">.</span><span class="n">alg</span>
                <span class="n">quad</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">meas</span> <span class="o">=</span> <span class="n">equations</span><span class="o">.</span><span class="n">meas</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">ode</span> <span class="o">=</span> <span class="n">equations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">alg</span> <span class="o">=</span> <span class="n">equations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">quad</span> <span class="o">=</span> <span class="n">equations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quad&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">meas</span> <span class="o">=</span> <span class="n">equations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;meas&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">quad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quad&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">meas</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;meas&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_dynamical_equations</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_algebraic_equations</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_quadrature_functions</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_measurement_equations</span><span class="p">(</span><span class="n">meas</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param opts:</span>
<span class="sd">        :param keys:</span>
<span class="sd">        :param values:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Check solver options at the end and omit options that are not used for the current solver</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">opts</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">check_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">check_consistency</span><span class="p">()</span>

        <span class="c1"># TODO: Check size2() as well (it should not be higher than 1)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">ode</span><span class="o">.</span><span class="n">size1</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Dimension mismatch between the dynamical states and the dynamical equations&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">size1</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Dimension mismatch between the measurements and the measurement equations&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="o">.</span><span class="n">size1</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Dimension mismatch between the algebraic states and the algebraic equations&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param solver:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Solver could also be the interface to a solver</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ca</span><span class="o">.</span><span class="n">has_integrator</span><span class="p">(</span><span class="n">solver</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;cvodes&#39;</span> <span class="ow">or</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;rk&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>
                                                                   <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Solver &#39;</span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2">&#39; is not suitable for DAE systems. Use &#39;idas&#39; or &#39;collocation&#39; &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;instead&quot;</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Solver &#39;</span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2">&#39; is not available on your system. Use &#39;cvodes&#39;, &#39;rk&#39; or &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;&#39;collocation&#39; instead&quot;</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Solver &#39;</span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2">&#39; is not available on your system. Use &#39;idas&#39; or &#39;collocation&#39; &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;instead&quot;</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Solver type must be a string&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model is discrete. No solver is required.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param name:</span>
<span class="sd">        :param setup:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_sx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_sx&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_sx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span>

        <span class="n">problem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">(</span><span class="n">use_sx</span><span class="o">=</span><span class="n">use_sx</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">free_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_state_space</span><span class="p">()</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">free_vars</span><span class="p">)</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;alg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;meas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">units</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;x_eq&#39;</span> <span class="ow">in</span> <span class="n">problem</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;x_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;z_eq&#39;</span> <span class="ow">in</span> <span class="n">problem</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;z_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;u_eq&#39;</span> <span class="ow">in</span> <span class="n">problem</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;u_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">units</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;X&#39;</span> <span class="ow">in</span> <span class="n">problem</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;Z&#39;</span> <span class="ow">in</span> <span class="n">problem</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">units</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">_Model</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">,</span> <span class="n">solver_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">,</span>
                       <span class="n">use_sx</span><span class="o">=</span><span class="n">use_sx</span><span class="p">)</span>

        <span class="c1"># TODO: What about other properties?</span>
        <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;display&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span>
        <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;linearized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g0</span>

        <span class="n">model</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">setup</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">model</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Model to be copied has no right-hand side, so the new model cannot be set up.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">is_linear</span><span class="p">():</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">generate_matrix_notation</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">discretize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param method:</span>
<span class="sd">        :param inplace:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add zero order hold for linear systems</span>
        <span class="c1"># TODO: What about keep_refs?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model is already discrete. Nothing to be done.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_consistency</span><span class="p">()</span>

        <span class="n">problem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">free_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_state_space</span><span class="p">()</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">free_vars</span><span class="p">)</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;alg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;meas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="c1"># TODO: What about mixtures of SX and MX?</span>
        <span class="n">use_sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rk4&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;explicit&#39;</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rk&#39;</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;runge-kutta&#39;</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;erk&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;explicit&#39;</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rk&#39;</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;runge-kutta&#39;</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;irk&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;implicit&#39;</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rk&#39;</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;runge-kutta&#39;</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;collocation&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;implicit&#39;</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;collocation&#39;</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;runge-kutta&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The discretization method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> is not implemented&quot;</span><span class="p">)</span>

        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">units</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;x_eq&#39;</span> <span class="ow">in</span> <span class="n">problem</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;x_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;z_eq&#39;</span> <span class="ow">in</span> <span class="n">problem</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;z_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;u_eq&#39;</span> <span class="ow">in</span> <span class="n">problem</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;u_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">units</span>
            <span class="p">}</span>

        <span class="n">continuous2discrete</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;explicit&#39;</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rk&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># TODO: Ignore variable t here if system is not time-variant, otherwise we need to supply a value for t as</span>
            <span class="c1">#  well when calling the corresponding MXFunction (during Model.setup(), in self._rhs.to_function())</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;discretization_points&#39;</span><span class="p">]</span>
            <span class="n">ode</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">]</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;alg&#39;</span><span class="p">]</span>
            <span class="n">meas</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;meas&#39;</span><span class="p">]</span>
            <span class="n">quad</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;quad&#39;</span><span class="p">]</span>

            <span class="c1"># q = root_finder([Z, dt, t, x, u, p], [ode, alg])</span>

            <span class="n">ode</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;ode&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">ode</span><span class="p">])</span>
            <span class="n">_alg</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">Z</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">alg</span><span class="p">])</span>
            <span class="n">_alg</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">rootfinder</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="s1">&#39;newton&#39;</span><span class="p">,</span> <span class="n">_alg</span><span class="p">)</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">z</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="p">])</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">rootfinder</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="s1">&#39;newton&#39;</span><span class="p">,</span> <span class="n">alg</span><span class="p">)</span>
            <span class="n">meas</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;meas&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">meas</span><span class="p">])</span>
            <span class="n">quad</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;quad&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">quad</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">use_sx</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
                <span class="c1"># NOTE: ca.vertcat() would return a ca.Sparsity object, if the corresponding lists were empty. Since we</span>
                <span class="c1">#  don&#39;t want do deal with ca.Sparsity at the moment during model setup, we do this workaround</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">y</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">y</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">z</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="n">u</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">u</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Z</span><span class="o">.</span><span class="n">elements</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">Z</span><span class="p">:</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">Z</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
            <span class="n">use_sx</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">_alg</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">xf</span> <span class="o">=</span> <span class="n">ode</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">qf</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">zf</span> <span class="o">=</span> <span class="n">alg</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">xf</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">yf</span> <span class="o">=</span> <span class="n">meas</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">xf</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">order</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">order</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">order</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">units</span>
            <span class="p">}</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;degree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>

            <span class="k">del</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;discretization_points&#39;</span><span class="p">]</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xf</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;alg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zf</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;meas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yf</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;quad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qf</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;implicit&#39;</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;collocation&#39;</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;collocation_points_ode&#39;</span><span class="p">])</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;collocation_points_alg&#39;</span><span class="p">])</span>
            <span class="n">col_eq</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;collocation_equations&#39;</span><span class="p">]</span>
            <span class="n">ode</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">]</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;alg&#39;</span><span class="p">]</span>
            <span class="n">meas</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;meas&#39;</span><span class="p">]</span>
            <span class="n">quad</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;quad&#39;</span><span class="p">]</span>

            <span class="n">col_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;col_eq&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">),</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">col_eq</span><span class="p">])</span>  <span class="c1"># We probably don&#39;t need</span>
            <span class="c1"># &#39;z&#39; here</span>
            <span class="n">col_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">rootfinder</span><span class="p">(</span><span class="s1">&#39;col_eq&#39;</span><span class="p">,</span> <span class="s1">&#39;newton&#39;</span><span class="p">,</span> <span class="n">col_eq</span><span class="p">)</span>
            <span class="n">function</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">),</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">ode</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">quad</span><span class="p">,</span> <span class="n">meas</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">use_sx</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
                <span class="c1"># NOTE: ca.vertcat() would return a ca.Sparsity object, if the corresponding lists were empty. Since we</span>
                <span class="c1">#  don&#39;t want to deal with ca.Sparsity at the moment during model setup, we do this workaround</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">y</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">y</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">z</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="n">u</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">u</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">elements</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">X</span><span class="p">:</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">X</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Z</span><span class="o">.</span><span class="n">elements</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">Z</span><span class="p">:</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">Z</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
            <span class="n">use_sx</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">degree</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;degree&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;degree&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="mi">2</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">col_eq</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">),</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">xf</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">qf</span><span class="p">,</span> <span class="n">yf</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">degree</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">degree</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">degree</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">units</span>
            <span class="p">}</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">degree</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">degree</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">degree</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">units</span>
            <span class="p">}</span>

            <span class="k">del</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;collocation_points_ode&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;collocation_points_alg&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;collocation_equations&#39;</span><span class="p">]</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xf</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;alg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zf</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;meas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yf</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;quad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qf</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="c1"># TODO: Remove solver options that are not used for discrete models</span>
            <span class="c1"># TODO: Use Model.copy here</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">_Model</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_discretized&#39;</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">,</span>
                               <span class="n">use_sx</span><span class="o">=</span><span class="n">use_sx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">_Model</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">,</span> <span class="n">use_sx</span><span class="o">=</span><span class="n">use_sx</span><span class="p">)</span>

            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;display&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;linearized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g0</span>

            <span class="n">model</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discrete</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_solver</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The model needs to be set up again in order to run simulations. If you want to prevent &quot;</span>
                              <span class="s2">&quot;this warning message from appearing, run Model.discretize(...) before Model.setup().&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrator_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_integrator_function</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meas_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meas_function</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">use_sx</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_dynamical_states</span><span class="p">(</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_measurements</span><span class="p">(</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_algebraic_states</span><span class="p">(</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">(</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
                <span class="n">equations</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;ode&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;alg&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;alg&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;quad&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;quad&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;meas&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;meas&#39;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_equations</span><span class="p">(</span><span class="o">**</span><span class="n">equations</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: Add _discretized suffix?</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_empty_model</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_autonomous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">is_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span>

    <span class="k">def</span> <span class="nf">is_linearized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span>

    <span class="k">def</span> <span class="nf">is_time_variant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_time_variant</span>

    <span class="k">def</span> <span class="nf">linearize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mod</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param name:</span>
<span class="sd">        :param trajectory:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: What about nonlinear quadrature functions?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model is already linearized. Nothing to be done.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model is already linear. Linearization is not necessary. Nothing to be done.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_rep</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model is already linear. Linearization is not necessary. Nothing to be done.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model is empty. Nothing to be done.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>

        <span class="n">problem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">()</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="c1"># y = problem[&#39;y&#39;]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span>
        <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">],</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;alg&#39;</span><span class="p">],</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;meas&#39;</span><span class="p">],</span> <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;quad&#39;</span><span class="p">]]</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">units</span>
            <span class="p">},</span>
            <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">units</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">x_s</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">z_s</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">u_s</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">trajectory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: Add support for trajectories in CasADi variables</span>
            <span class="n">trajectories</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">x_trajectory</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">u_trajectory</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_trajectory</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">trajectories</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x_trajectory</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">x_trajectory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_trajectory</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch for dynamical state trajectory. Expected trajectory of dimension &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u_trajectory</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">trajectories</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">u_trajectory</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">u_trajectory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u_trajectory</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch for input trajectory. Expected trajectory of dimension &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">trajectories</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;trj_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">(k)=&#39;</span> <span class="o">+</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trajectories</span><span class="p">)]</span>
            <span class="n">var</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;discrete&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="p">,</span>
                <span class="s1">&#39;use_sx&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span><span class="p">,</span>
                <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">dt</span><span class="p">],</span>
                <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">trj</span> <span class="o">=</span> <span class="n">parse_dynamic_equations</span><span class="p">(</span><span class="n">trajectories</span><span class="p">,</span> <span class="o">**</span><span class="n">var</span><span class="p">)[</span><span class="s1">&#39;meas&#39;</span><span class="p">]</span>
            <span class="n">x_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">trj</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="p">])</span>
            <span class="n">u_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="n">trj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="p">:])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
                <span class="k">if</span> <span class="n">x_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">x_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_eq&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">x_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">x_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
                <span class="k">if</span> <span class="n">z_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">z_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_eq&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">z_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">z_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">du</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
                <span class="k">if</span> <span class="n">u_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">u_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_eq&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">du</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">u_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">u_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
                <span class="k">if</span> <span class="n">x_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">x_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_eq&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">x_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">x_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
                <span class="k">if</span> <span class="n">z_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">z_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_eq&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">z_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">z_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">du</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
                <span class="k">if</span> <span class="n">u_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">u_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_eq&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">elements</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">du</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">u_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">u_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">()</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;x_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;z_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;u_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">units</span>
        <span class="p">}</span>

        <span class="n">xzu</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
        <span class="n">xzu_s</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">x_s</span><span class="p">,</span> <span class="n">z_s</span><span class="p">,</span> <span class="n">u_s</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">eq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">equations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">dx</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">dyn_state_derivative</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">jtimes</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span><span class="p">:</span>
                    <span class="n">dyn_state_derivative</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dyn_state_derivative</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">dz</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">alg_state_derivative</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">jtimes</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span><span class="p">:</span>
                    <span class="n">alg_state_derivative</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alg_state_derivative</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">du</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">input_derivative</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">jtimes</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">du</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span><span class="p">:</span>
                    <span class="n">input_derivative</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">input_derivative</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="n">taylor</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">dyn_state_derivative</span> <span class="o">+</span> <span class="n">alg_state_derivative</span> <span class="o">+</span> <span class="n">input_derivative</span><span class="p">,</span> <span class="n">xzu</span><span class="p">,</span> <span class="n">xzu_s</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
                    <span class="n">eq</span> <span class="o">-=</span> <span class="n">x</span>
                <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">xzu</span><span class="p">,</span> <span class="n">xzu_s</span><span class="p">)</span>
                <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;ode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">taylor</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">xzu</span><span class="p">,</span> <span class="n">xzu_s</span><span class="p">)</span>
                <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;alg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">taylor</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;meas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">taylor</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># TODO: See above (quadrature)</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_linearized&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">_Model</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">,</span> <span class="n">solver_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">,</span>
                       <span class="n">use_sx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_sx</span><span class="p">)</span>

        <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span>
        <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dz</span>
        <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">du</span>
        <span class="k">if</span> <span class="n">trajectory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;x_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_s</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;z_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_s</span>
            <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;u_eq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_s</span>

        <span class="c1"># TODO: What about other properties?</span>
        <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;display&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display</span>
        <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;linearized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">trajectory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;f0&#39;</span> <span class="ow">in</span> <span class="n">problem</span><span class="p">:</span>
                <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;f0&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_s</span><span class="p">,</span> <span class="n">z_s</span><span class="p">,</span> <span class="n">u_s</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]])</span>
            <span class="k">if</span> <span class="s1">&#39;g0&#39;</span> <span class="ow">in</span> <span class="n">problem</span><span class="p">:</span>
                <span class="n">problem</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;g0&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_s</span><span class="p">,</span> <span class="n">z_s</span><span class="p">,</span> <span class="n">u_s</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="p">[</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;linearized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;trajectory&#39;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">remove_dynamical_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices_or_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param indices_or_names:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">indices_or_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">remove_measurements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices_or_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param indices_or_names:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">indices_or_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">remove_algebraic_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices_or_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param indices_or_names:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">indices_or_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_solver</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">remove_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices_or_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param indices_or_names:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">indices_or_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">remove_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices_or_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param indices_or_names:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">indices_or_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">remove_dynamical_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param indices:</span>
<span class="sd">        :param check_properties:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">(</span><span class="s1">&#39;ode&#39;</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">remove_algebraic_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param indices:</span>
<span class="sd">        :param check_properties:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">(</span><span class="s1">&#39;alg&#39;</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_solver</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">check_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">remove_quadrature_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param indices:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">(</span><span class="s1">&#39;quad&#39;</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_measurement_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param indices:</span>
<span class="sd">        :param check_properties:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">(</span><span class="s1">&#39;meas&#39;</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">remove_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">meas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param ode:</span>
<span class="sd">        :param alg:</span>
<span class="sd">        :param quad:</span>
<span class="sd">        :param meas:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_dynamical_equations</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_algebraic_equations</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_quadrature_functions</span><span class="p">(</span><span class="n">quad</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_measurement_equations</span><span class="p">(</span><span class="n">meas</span><span class="p">,</span> <span class="n">check_properties</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param keys:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="c1"># NOTE: This should work, otherwise use self._solver_opts.pop(key, None)</span>
                <span class="c1"># It could be possible that &#39;key&#39; is present during the if-condition, but not at the &#39;del&#39; statement</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># NOTE: See first if-condition</span>
            <span class="k">if</span> <span class="n">keys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Wrong type &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; of attribute for function </span><span class="si">{</span><span class="n">who_am_i</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: What else to reset? Maybe solution?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_integrator_function</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meas_function</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add keyword argument &#39;input_function&#39; to allow continuous input signals via PID or LQR</span>
        <span class="c1"># TODO: Add support for time grid</span>
        <span class="c1"># TODO: Check time-dependent odes</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;opts&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">)</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t0</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="c1"># TODO: add tf (tf = t0 + dt)?</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t0</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;tf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">free_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_state_space</span><span class="p">()</span>

            <span class="c1"># TODO: Is this sufficient enough?</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span> <span class="ow">and</span> <span class="n">ca</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Switching model &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to discrete, since discrete time dynamics were supplied for the &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;state equations.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ca</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The model was initialized as a discrete model, but no sampling time was supplied. &quot;</span>
                              <span class="s2">&quot;Use Model.dt to extract the sampling time.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_dynamical_states</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">z</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_algebraic_states</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">y</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_measurements</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">u</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">free_vars</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">free_vars</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_parameters</span><span class="p">(</span><span class="n">free_vars</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_equations</span><span class="p">(</span><span class="n">ode</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">meas</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span> <span class="ow">and</span> <span class="n">ca</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">ode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Switching model &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to discrete, since discrete time dynamics were supplied for the &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;state equations.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ca</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">ode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The model was initialized as a discrete model, but no sampling time was implemented in &quot;</span>
                              <span class="s2">&quot;the model. Assuming that the sampling time &#39;dt&#39; is already integrated numerically.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>

        <span class="n">generate_matrix_notation</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;generate_matrix_notation&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">generate_matrix_notation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">generate_matrix_notation</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">generate_matrix_notation</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">matrix_notation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
                <span class="n">generate_matrix_notation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linear</span> <span class="ow">and</span> <span class="n">generate_matrix_notation</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">generate_matrix_notation</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">col_points</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">col_points</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">col_points</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="p">,</span> <span class="p">(</span><span class="n">GenericCost</span><span class="p">,</span> <span class="n">QuadraticCost</span><span class="p">)):</span>
            <span class="n">quad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="o">.</span><span class="n">cost</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">quad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span>

        <span class="n">steady_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span><span class="p">:</span>
            <span class="n">steady_state</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">function</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">meas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">to_function</span><span class="p">(</span><span class="s1">&#39;integrator&#39;</span><span class="p">,</span> <span class="n">quadrature</span><span class="o">=</span><span class="n">quad</span><span class="p">,</span>
                                                           <span class="n">external_parameters</span><span class="o">=</span><span class="n">steady_state</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                                                           <span class="n">generate_matrix_notation</span><span class="o">=</span><span class="n">generate_matrix_notation</span><span class="p">,</span>
                                                           <span class="o">**</span><span class="n">col_points</span><span class="p">)</span>

        <span class="n">use_c_code</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c_code&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_c_code</span><span class="p">:</span>
            <span class="n">gen_path</span><span class="p">,</span> <span class="n">gen_name</span><span class="p">,</span> <span class="n">gen_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gen_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_c_name</span> <span class="o">=</span> <span class="n">generate_c_code</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">gen_path</span><span class="p">,</span> <span class="n">gen_name</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="n">gen_opts</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiler_opts</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">JIT</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiler_opts</span><span class="p">[</span><span class="s1">&#39;compiler&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shell&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_compiler_opts</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_path</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="o">=</span> <span class="s1">&#39;integrator_continuous&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="o">=</span> <span class="s1">&#39;integrator_discrete&#39;</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="o">=</span> <span class="n">function</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="o">=</span> <span class="n">function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_integrator_function</span> <span class="o">=</span> <span class="n">integrator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meas_function</span> <span class="o">=</span> <span class="n">meas</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_consistency</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model.substitute() can only accept positional or keyword arguments, not both&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;No more than 2 positional arguments allowed&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

        <span class="n">model_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;states&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;parameters&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># TODO: Support for symbolic parameters</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span> <span class="o">**</span><span class="n">val</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">model_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">model_changed</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The model needs to be set up again in order to run simulations. If you want to prevent &quot;</span>
                              <span class="s2">&quot;this warning message from appearing, run Model.substitute(...) before Model.setup().&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrator_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_integrator_function</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meas_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meas_function</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_check_linearity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_variance</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_space_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">substitute_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param obj:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Error handling</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">LearningBase</span><span class="p">):</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>
            <span class="n">predict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;predict&#39;</span><span class="p">)</span>
            <span class="n">all_the_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">names</span>
            <span class="n">all_the_variables</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">use_sx</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_the_variables</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">)</span>
            <span class="c1"># all_the_indices = [k for k, val in enumerate(all_the_names) if val in obj.features]</span>
            <span class="n">all_the_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_the_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">features</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">predict</span><span class="p">):</span>
                <span class="c1"># TODO: Check the following if-else statement</span>
                <span class="k">if</span> <span class="n">use_sx</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">all_the_variables</span><span class="p">[</span><span class="n">all_the_indices</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">all_the_variables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_the_indices</span><span class="p">]))</span>
                <span class="c1"># TODO: Maybe add a parameter return_variance (defaults to False) to the predict method of the GPR</span>
                <span class="c1">#  instead?</span>
                <span class="k">if</span> <span class="n">is_list_like</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">learned</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">substitute_from</span><span class="p">(</span><span class="n">learned</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>
            <span class="n">all_the_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">names</span>
            <span class="n">all_the_variables</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">use_sx</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_the_variables</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">SX</span><span class="p">)</span>
            <span class="n">function</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
                <span class="c1"># all_the_indices = [k for k, val in enumerate(all_the_names) if val in function.name_in()]</span>
                <span class="n">all_the_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_the_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">name_in</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">function</span><span class="o">.</span><span class="n">numel_in</span><span class="p">()</span> <span class="o">==</span> <span class="n">function</span><span class="o">.</span><span class="n">n_in</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">use_sx</span><span class="p">:</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">all_the_variables</span><span class="p">[</span><span class="n">all_the_indices</span><span class="p">]</span><span class="o">.</span><span class="n">elements</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">all_the_variables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_the_indices</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">all_the_variables</span><span class="p">[</span><span class="n">all_the_indices</span><span class="p">])</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">:</span>
                            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">:</span>
                            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">:</span>
                            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="p">:</span>
                            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">:</span>
                            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> to Model.substitute_from() not supported&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scale</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Numeric</span><span class="p">,</span> <span class="n">NumArray</span><span class="p">],</span>
            <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param value:</span>
<span class="sd">        :param id:</span>
<span class="sd">        :param name:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: Raise error here?</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No identifier and no name supplied. No changes applied...&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: Raise error here?</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Both keyword arguments &#39;id&#39; and &#39;name&#39; were supplied. This is not allowed. No changes &quot;</span>
                          <span class="s2">&quot;applied...&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span>
                <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="s1">&#39;ode&#39;</span>
            <span class="k">elif</span> <span class="nb">id</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span>
                <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="s1">&#39;meas&#39;</span>
            <span class="k">elif</span> <span class="nb">id</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span>
                <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">names</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="s1">&#39;alg&#39;</span>
            <span class="k">elif</span> <span class="nb">id</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span>
                <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">id</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span>
                <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">names</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: Raise error here?</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized identifier: </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="se">\n</span><span class="s2">No changes applied...&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="s1">&#39;ode&#39;</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="s1">&#39;meas&#39;</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="s1">&#39;alg&#39;</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: Raise error here?</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">No changes applied...&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="n">eq</span><span class="p">)</span>


<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../../../api/modelling.html#hilo_mpc.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">_Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the dynamic model of a system over time</span>

<span class="sd">    :param id: The identifier of the model object. If no identifier is given, a random one will be generated.</span>
<span class="sd">    :type id: str, optional</span>
<span class="sd">    :param name: The name of the model object. By default the model object has no name.</span>
<span class="sd">    :type name: str, optional</span>
<span class="sd">    :param discrete: Whether or not the dynamics of the model are discrete, defaults to False (i.e. the model has</span>
<span class="sd">        continuous-time dynamics)</span>
<span class="sd">    :type discrete: bool, optional</span>
<span class="sd">    :param solver: Name of the solver to be used for continuous-time integration, defaults to &#39;cvodes&#39; if **discrete**</span>
<span class="sd">        is set to False. If **discrete** is set to True the argument **solver** will not be used.</span>
<span class="sd">    :type solver: str, optional</span>
<span class="sd">    :param solver_options: Options to be passed to the selected **solver**. Only used when the model has continuous-time</span>
<span class="sd">        dynamics. By default no options will be set.</span>
<span class="sd">    :type solver_options: dict, optional</span>
<span class="sd">    :param time_unit: The time unit of the model. Common time units are seconds (&#39;s&#39;), hours (&#39;h&#39;) or days (&#39;d&#39;). Will</span>
<span class="sd">        only be used for plotting and as an information storage. Defaults to &#39;h&#39;.</span>
<span class="sd">    :type time_unit: str</span>
<span class="sd">    :param plot_backend: Plotting library that is used to visualize simulated data. At the moment only</span>
<span class="sd">        `Matplotlib &lt;https://matplotlib.org/&gt;`_ and `Bokeh &lt;https://bokeh.org/&gt;`_ are supported. By default no plotting</span>
<span class="sd">        library is selected, i.e. no plots can be generated.</span>
<span class="sd">    :type plot_backend: str, optional</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">discrete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">solver</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">solver_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">time_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span>
            <span class="n">plot_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor method&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="n">discrete</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver_options</span><span class="o">=</span><span class="n">solver_options</span><span class="p">,</span>
                         <span class="n">time_unit</span><span class="o">=</span><span class="n">time_unit</span><span class="p">,</span> <span class="n">use_sx</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span><span class="n">plot_backend</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span><span class="n">plot_backend</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># TODO: Figure out if we really need self._collocation_points as a TimeSeries class, since the only occurrences</span>
        <span class="c1">#  at the moment just involve the degree.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collocation_points</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span><span class="n">plot_backend</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dxdp_nnz</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dydp_nnz</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dzdp_nnz</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;id=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, name=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, discrete=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">discrete</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, solver=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, solver_options=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver_opts</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">plot_backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, plot_backend=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">plot_backend</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">str_repr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">add_newline</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">ode</span><span class="o">.</span><span class="n">elements</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">str_repr</span> <span class="o">+=</span> <span class="s2">&quot;# ODEs</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">add_newline</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">str_repr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;d</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2">/dt = </span><span class="si">{</span><span class="n">ode</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">add_newline</span><span class="p">:</span>
            <span class="n">str_repr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">add_newline</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">alg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="o">.</span><span class="n">elements</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">str_repr</span> <span class="o">+=</span> <span class="s2">&quot;# ALGs</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">add_newline</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">str_repr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;0 = </span><span class="si">{</span><span class="n">alg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">add_newline</span><span class="p">:</span>
            <span class="n">str_repr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">add_newline</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">meas</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">meas</span><span class="o">.</span><span class="n">elements</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">str_repr</span> <span class="o">+=</span> <span class="s2">&quot;# MEAS</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">str_repr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">meas</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">str_repr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">initial_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        :rtype: DM</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;t&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="c1"># TODO: Put warnings here, to inform user?</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;t:0&#39;</span><span class="p">)</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">initial_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">initial_dynamical_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="c1"># TODO: Put warnings here, to inform user?</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;x:0&#39;</span><span class="p">)</span>

    <span class="n">x0</span> <span class="o">=</span> <span class="n">initial_dynamical_states</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">initial_algebraic_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="c1"># TODO: Put warnings here, to inform user?</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;z:0&#39;</span><span class="p">)</span>

    <span class="n">z0</span> <span class="o">=</span> <span class="n">initial_algebraic_states</span>

<div class="viewcode-block" id="Model.set_initial_conditions"><a class="viewcode-back" href="../../../../api/modelling.html#hilo_mpc.Model.set_initial_conditions">[docs]</a>    <span class="k">def</span> <span class="nf">set_initial_conditions</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">x0</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Numeric</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">],</span>
            <span class="n">t0</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="n">z0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Numeric</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param x0:</span>
<span class="sd">        :param t0:</span>
<span class="sd">        :param z0:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Check consistency of solution object?</span>
        <span class="c1"># TODO: See set_equilibrium_point (see TODO above)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">is_set_up</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model is not set up. Run Model.setup() before setting the initial conditions.&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: Support for time grids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="c1"># NOTE: &#39;warnings.catch_warnings&#39; is not thread-safe. Don&#39;t know if that needs to concern us.</span>
            <span class="c1"># TODO: We could also rewrite TimeSeries.set so that it doesn&#39;t care if it&#39;s already populated and handle</span>
            <span class="c1">#  the processing entirely here (if Vector is not empty)</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
                <span class="c1"># self._solution.set(&#39;x0_noise&#39;, 0.)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x_noise</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="p">))</span>
            <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">w</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="ne">UserWarning</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="o">==</span>
                     <span class="s2">&quot;Vector is not empty. No changes applied.&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The model has already been simulated. Please reset the solution of the model in order to&quot;</span>
                              <span class="s2">&quot; record a new solution. No changes applied.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: Raise an error here?</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Initial dynamical states cannot be set, since no dynamical states are defined for the model.&quot;</span>
                          <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">z0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The initial values for the algebraic states also have to be set in order to simulate &quot;</span>
                                 <span class="s2">&quot;the model.&quot;</span><span class="p">)</span>
            <span class="c1"># NOTE: &#39;warnings.catch_warnings&#39; is not thread-safe. Don&#39;t know if that needs to concern us.</span>
            <span class="c1"># TODO: We could also rewrite TimeSeries.set so that it doesn&#39;t care if it&#39;s already populated and handle</span>
            <span class="c1">#  the processing entirely here (if Vector is not empty)</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">z0</span><span class="p">)</span>
                <span class="c1"># self._solution.set(&#39;z0_noise&#39;, 0.)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">z_noise</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="p">))</span>
            <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">w</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="ne">UserWarning</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="o">==</span>
                     <span class="s2">&quot;Vector is not empty. No changes applied.&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The model has already been simulated. Please reset the solution of the model in order to&quot;</span>
                              <span class="s2">&quot; record a new solution. No changes applied.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">z0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Initial algebraic states cannot be set, since no algebraic states are defined for the model.&quot;</span>
                          <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dydp_nnz</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please set the values for the parameters by executing the &quot;</span>
                                   <span class="s2">&quot;&#39;set_initial_parameter_values&#39; method before setting the initial conditions.&quot;</span><span class="p">)</span>

            <span class="n">to_skip</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dydp_nnz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">to_skip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_function_args</span><span class="p">(</span><span class="n">skip</span><span class="o">=</span><span class="n">to_skip</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dydp_nnz</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span><span class="p">)</span>

            <span class="c1"># NOTE: dt is subtracted for time-variant systems due to the way the function for the measurement</span>
            <span class="c1">#  equation is generated</span>
            <span class="c1"># TODO: What about time grids?</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">dt</span>
            <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="p">),</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_time_variant</span><span class="p">:</span>
                        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">t0</span> <span class="o">-</span> <span class="n">dt</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_time_variant</span><span class="p">:</span>
                            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">t0</span> <span class="o">-</span> <span class="n">dt</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_time_variant</span><span class="p">:</span>
                            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">-</span> <span class="n">dt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">grid</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Grids are not yet supported for calculating the initial measurements.&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meas_function</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)[</span><span class="s1">&#39;yf&#39;</span><span class="p">])</span>
                <span class="c1"># TODO: Make the following line work (see Series.set)</span>
                <span class="c1"># self._solution.set(&#39;y0_noise&#39;, 0.)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y_noise</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span><span class="p">))</span>
            <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">w</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="ne">UserWarning</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="o">==</span>
                     <span class="s2">&quot;Vector is not empty. No changes applied.&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The model has already been simulated. Please reset the solution of the model in order to&quot;</span>
                              <span class="s2">&quot; record a new solution. No changes applied.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.set_initial_parameter_values"><a class="viewcode-back" href="../../../../api/modelling.html#hilo_mpc.Model.set_initial_parameter_values">[docs]</a>    <span class="k">def</span> <span class="nf">set_initial_parameter_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Numeric</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param p:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: See set_equilibrium_point</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> doesn&#39;t have any parameters&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">set_equilibrium_point</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">x_eq</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Numeric</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">z_eq</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Numeric</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">u_eq</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Numeric</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">t0</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-8</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param x_eq:</span>
<span class="sd">        :param z_eq:</span>
<span class="sd">        :param u_eq:</span>
<span class="sd">        :param t0:</span>
<span class="sd">        :param tol:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model is not linearized. Supplying an equilibrium point is not necessary. No changes applied.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">x_eq</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dynamical state information is missing from the equilibrium point.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">z_eq</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Algebraic state information is missing from the equilibrium point.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u_eq</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input information is missing from the equilibrium point.&quot;</span><span class="p">)</span>

        <span class="n">x_eq</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">x_eq</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">)</span>
        <span class="n">z_eq</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">z_eq</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">)</span>
        <span class="n">u_eq</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">u_eq</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">x_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch for the dynamical state information of the equilibrium point. &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="n">x_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">, expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">z_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch for the algebraic state information of the equilibrium point. &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="n">z_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">, expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch for the input information of the equilibrium point. &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="n">u_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">, expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dxdp_nnz</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dzdp_nnz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="c1"># NOTE: The symbolic linearization should also contain the parameters of the original nonlinear model, i.e.,</span>
            <span class="c1">#  if the symbolic linearized model depends on parameters, so does the original nonlinear model, which we</span>
            <span class="c1">#  will use to check the equilibrium point.</span>
            <span class="c1"># TODO: Or maybe have a link to original Model object and execute that instead of storing a function in</span>
            <span class="c1">#  self._steady_state?</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please set the values for the parameters by executing the &quot;</span>
                               <span class="s2">&quot;&#39;set_initial_parameter_values&#39; method before setting the equilibrium point.&quot;</span><span class="p">)</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">dt</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;p:f&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f0</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">x_eq</span><span class="p">,</span> <span class="n">z_eq</span><span class="p">,</span> <span class="n">u_eq</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ca</span><span class="o">.</span><span class="n">logic_all</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">f0</span><span class="o">.</span><span class="n">fabs</span><span class="p">(),</span> <span class="n">tol</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Supplied values are not an equilibrium point. Maximum error: &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">mmax</span><span class="p">(</span><span class="n">f0</span><span class="o">.</span><span class="n">fabs</span><span class="p">()))</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g0</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">x_eq</span><span class="p">,</span> <span class="n">z_eq</span><span class="p">,</span> <span class="n">u_eq</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ca</span><span class="o">.</span><span class="n">logic_all</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">g0</span><span class="o">.</span><span class="n">fabs</span><span class="p">(),</span> <span class="n">tol</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Supplied values are not an equilibrium point. Maximum error: &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">mmax</span><span class="p">(</span><span class="n">g0</span><span class="o">.</span><span class="n">fabs</span><span class="p">()))</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_eq</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">z_eq</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">u_eq</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span>

<div class="viewcode-block" id="Model.copy"><a class="viewcode-back" href="../../../../api/modelling.html#hilo_mpc.Model.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param name:</span>
<span class="sd">        :param setup:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_setup</span><span class="p">():</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">dt</span>
                    <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">grid</span>

        <span class="n">_model</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">plot_backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">plot_backend</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">_model</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">setup</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Model to be copied has no right-hand side, so the new model cannot be set up.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_linear</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">generate_matrix_notation</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="Model.discretize"><a class="viewcode-back" href="../../../../api/modelling.html#hilo_mpc.Model.discretize">[docs]</a>    <span class="k">def</span> <span class="nf">discretize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">butcher_tableau</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">degree</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">polynomial_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discretize a continuous-time model. Implemented discretization methods are explicit Runge-Kutta and collocation</span>
<span class="sd">        schemes.</span>

<span class="sd">        :note: The :meth:`~hilo_mpc.core.model.Model.discretize` method doesn&#39;t require a numerical sampling time</span>
<span class="sd">            &#39;dt&#39;, since the discretization is executed symbolically.</span>

<span class="sd">        :note: If the model is already discrete, an according message will be displayed and the discretization attempt</span>
<span class="sd">            will be aborted.</span>

<span class="sd">        :param method: The method used for discretization. At the moment only explicit Runge-Kutta methods and</span>
<span class="sd">            collocation schemes are supported. Accepted values are &#39;rk4&#39; for the most widely known 4th order</span>
<span class="sd">            Runge-Kutta method, &#39;erk&#39; for general order explicit Runge-Kutta methods and &#39;collocation&#39; for the implicit</span>
<span class="sd">            collocation methods.</span>
<span class="sd">        :type method: str</span>
<span class="sd">        :param order: Order of the explicit Runge-Kutta method &#39;erk&#39;. Supported orders are 1 to 4. Will be ignored if</span>
<span class="sd">            &#39;rk4&#39; or &#39;collocation&#39; is selected. Defaults to 1 for &#39;erk&#39;.</span>
<span class="sd">        :type order: int, optional</span>
<span class="sd">        :param butcher_tableau: The Butcher tableau used in the discretization with the explicit Runge-Kutta method</span>
<span class="sd">            &#39;erk&#39;. Will be ignored if &#39;rk4&#39; or &#39;collocation&#39; is selected. The default value of the Butcher tableau</span>
<span class="sd">            depends on the order of the explicit Runge-Kutta method. For more information on the Butcher tableau refer</span>
<span class="sd">            to the :ref:`Modules &lt;modelling_module&gt;` section.</span>
<span class="sd">        :type butcher_tableau: str, optional</span>
<span class="sd">        :param degree: Degree of the interpolating polynomial used in the collocation method. Will be ignored if &#39;erk&#39;</span>
<span class="sd">            or &#39;rk4&#39; is selected. Defaults to 2 for &#39;collocation&#39;.</span>
<span class="sd">        :type degree: int, optional</span>
<span class="sd">        :param polynomial_type: Polynomial used for calculating the collocation points, i.e. the roots of the</span>
<span class="sd">            polynomial. At the moment only Gauss-Legendre polynomials and Gauss-Radau polynomials are supported. Set</span>
<span class="sd">            **polynomial_type** to &#39;legendre&#39; for Gauss-Legendre polynomials and to &#39;radau&#39; for Gauss-Radau polynomials.</span>
<span class="sd">            Will be ignored if &#39;erk&#39; or &#39;rk4&#39; is selected. Defaults to &#39;radau&#39; for &#39;collocation&#39;.</span>
<span class="sd">        :type polynomial_type: str, optional</span>
<span class="sd">        :param inplace: If True, do discretization on the current :class:`~hilo_mpc.core.model.Model` instance and</span>
<span class="sd">            return None, otherwise a new discretized :class:`~hilo_mpc.core.model.Model` instance will be returned.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        :type inplace: bool</span>
<span class="sd">        :return: If argument **inplace** was set to True a new :class:`~hilo_mpc.core.model.Model` instance will be</span>
<span class="sd">            returned, otherwise None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;collocation&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">degree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">degree</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;degree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">degree</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;collocation_points&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polynomial_type</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;erk&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;butcher_tableau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">butcher_tableau</span>

        <span class="n">_model</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">discretize</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Basically means &#39;inplace&#39; parameter was set to False</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">plot_backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">plot_backend</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">_model</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;collocation&#39;</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_collocation_points</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span>

            <span class="k">return</span> <span class="n">model</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;collocation&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collocation_points</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span></div>

<div class="viewcode-block" id="Model.linearize"><a class="viewcode-back" href="../../../../api/modelling.html#hilo_mpc.Model.linearize">[docs]</a>    <span class="k">def</span> <span class="nf">linearize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Model&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param name:</span>
<span class="sd">        :param trajectory:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_model</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">linearize</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">trajectory</span><span class="o">=</span><span class="n">trajectory</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">plot_backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">plot_backend</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">_model</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">is_linear</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Linearized model is not linear.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="Model.reset_solution"><a class="viewcode-back" href="../../../../api/modelling.html#hilo_mpc.Model.reset_solution">[docs]</a>    <span class="k">def</span> <span class="nf">reset_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_initial_conditions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">keep_equilibrium_point</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param keep_initial_conditions:</span>
<span class="sd">        :param keep_equilibrium_point:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">keep_initial_conditions</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># NOTE: To completely remove references and bounds (maybe there&#39;s a better way)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">skip</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;noise&#39;</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">keep_equilibrium_point</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># NOTE: We don&#39;t want to clear the complete array here, since this is supposed to be a parameter.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.setup"><a class="viewcode-back" href="../../../../api/modelling.html#hilo_mpc.Model.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add support for time grid</span>
        <span class="c1"># TODO: Check time-dependent odes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sampling time &#39;dt&#39; was not supplied. Assuming a sampling time of &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;&#39;dt=1</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dxdp_nnz</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">ode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">nnz</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dydp_nnz</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">meas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">nnz</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dzdp_nnz</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">alg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">nnz</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">dt</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">grid</span>
            <span class="p">}</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
        <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
            <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span>
            <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span>
            <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_q</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span>
            <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_q</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
            <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">,</span> <span class="o">**</span><span class="n">vector</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
                <span class="n">vector</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">dt</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
                <span class="n">vector</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">grid</span>
                <span class="p">}</span>
            <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
            <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
                <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                    <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_eq</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                    <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># x_eq and x should have the same dimensions</span>
                    <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
                <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
                <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                    <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_eq</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                    <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># z_eq and z should have the same dimensions</span>
                    <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
                <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span>
                <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                    <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u_eq</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                    <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># u_eq and u should have the same dimensions</span>
                    <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
                <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">,</span> <span class="o">**</span><span class="n">vector</span><span class="p">)</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">size1</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
            <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;values_or_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">size1</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;data_format&#39;</span><span class="p">:</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span>
            <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collocation_points</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">,</span> <span class="o">**</span><span class="n">vector</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.simulate"><a class="viewcode-back" href="../../../../api/modelling.html#hilo_mpc.Model.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Throw error when SX and MX are mixed</span>
        <span class="c1"># TODO: What if time grid is chosen?</span>
        <span class="c1"># TODO: Deal with time span as an argument</span>
        <span class="c1"># TODO: Deal with time-dependent DAEs</span>
        <span class="c1"># TODO: Deal with sporadic measurement (not equidistant).</span>
        <span class="c1"># NOTE: Sporadic measurement time points should be multiples of dt.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># NOTE: Not sure if we want to throw an error here</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model is not set up. Run Model.setup() before running simulations.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No initial dynamical states found. Please set initial conditions before simulating the &quot;</span>
                               <span class="s2">&quot;model!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No initial algebraic states found. Please set initial conditions before simulating the &quot;</span>
                               <span class="s2">&quot;model!&quot;</span><span class="p">)</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tf</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the inputs &#39;u&#39; is &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">u</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">u</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">!=</span> <span class="n">steps</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the inputs &#39;u&#39; is &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">u</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">u</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">!=</span> <span class="n">steps</span><span class="p">:</span>
                    <span class="n">steps</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NOTE: Instead of checking whether &#39;u&#39; is contained in self._solution, we could also check if</span>
            <span class="c1">#  self._n_u &gt; 0, since we only get here if the model is set up</span>
            <span class="k">if</span> <span class="s1">&#39;u&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No input &#39;u&#39; to the system was supplied&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the parameters &#39;p&#39; is &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">!=</span> <span class="n">steps</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the parameters &#39;p&#39; is &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">!=</span> <span class="n">steps</span><span class="p">:</span>
                    <span class="n">steps</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NOTE: Instead of checking whether &#39;p&#39; is contained in self._solution, we could also check if</span>
            <span class="c1">#  self._n_p &gt; 0, since we only get here if the model is set up</span>
            <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No parameter &#39;p&#39; of the system was supplied&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">size2</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tf</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">*</span> <span class="n">dt</span>
                <span class="c1"># NOTE: Don&#39;t know if this is necessary</span>
                <span class="n">tf</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">grid</span>
            <span class="n">tf</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="p">[</span><span class="s1">&#39;t:f&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># TODO: Add to_skip from kwargs</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">get_function_args</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_time_variant</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">t_args</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">horzcat</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">tf</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t_args</span> <span class="o">=</span> <span class="n">t0</span>
            <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">t_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_args</span>
        <span class="n">tf</span> <span class="o">+=</span> <span class="n">t0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_linearized</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linearization_about_trajectory</span><span class="p">:</span>
            <span class="n">x_eq_is_required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>
            <span class="n">z_eq_is_required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>
            <span class="n">u_eq_is_required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x_eq_is_required</span> <span class="ow">or</span> <span class="n">z_eq_is_required</span> <span class="ow">or</span> <span class="n">u_eq_is_required</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model is linearized, but no equilibrium point was set. Please set equilibrium point&quot;</span>
                                   <span class="s2">&quot; before simulating the model!&quot;</span><span class="p">)</span>

            <span class="n">x_eq</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x_eq&#39;</span><span class="p">)</span>
            <span class="n">z_eq</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;z_eq&#39;</span><span class="p">)</span>
            <span class="n">u_eq</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;u_eq&#39;</span><span class="p">)</span>
            <span class="n">check_eq</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">x_eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x_eq</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">x_eq</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the equilibrium point &#39;x_eq&#39; is &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">x_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">x_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">x_eq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">x_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">!=</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the equilibrium point &#39;x_eq&#39; is &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">x_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">check_eq</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># NOTE: Instead of checking whether &#39;x&#39; is contained in self._steady_state, we could also check if</span>
                <span class="c1">#  self._n_x &gt; 0, since we only get here if the model is set up</span>
                <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="p">:</span>
                    <span class="n">x_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">x_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                        <span class="c1"># NOTE: We should not get here</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No parameter &#39;x_eq&#39; of the system was supplied&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">x_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">x_eq</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span> <span class="o">-</span> <span class="n">x_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_eq</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_eq</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">z_eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">z_eq</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">z_eq</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">z_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the equilibrium point &#39;z_eq&#39; is &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">z_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">z_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">z_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">z_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">z_eq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">z_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">!=</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the equilibrium point &#39;z_eq&#39; is &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">z_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">z_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">check_eq</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># NOTE: Instead of checking whether &#39;z&#39; is contained in self._steady_state, we could also check if</span>
                <span class="c1">#  self._n_z &gt; 0, since we only get here if the model is set up</span>
                <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="p">:</span>
                    <span class="n">z_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">z_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                        <span class="c1"># NOTE: We should not get here</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No parameter &#39;z_eq&#39; of the system was supplied&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">z_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">z_eq</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span> <span class="o">-</span> <span class="n">z_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">z_eq</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">z_eq</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">u_eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">u_eq</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">u_eq</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the equilibrium point &#39;u_eq&#39; is &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">u_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">u_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">u_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">u_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">u_eq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">u_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">!=</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the equilibrium point &#39;u_eq&#39; is &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">u_eq</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">u_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">check_eq</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># NOTE: Instead of checking whether &#39;u&#39; is contained in self._steady_state, we could also check if</span>
                <span class="c1">#  self._n_u &gt; 0, since we only get here if the model is set up</span>
                <span class="k">if</span> <span class="s1">&#39;u&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="p">:</span>
                    <span class="n">u_eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">u_eq</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                        <span class="c1"># NOTE: We should not get here</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No parameter &#39;u_eq&#39; of the system was supplied&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">u_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">u_eq</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span> <span class="o">-</span> <span class="n">u_eq</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">u_eq</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">u_eq</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">u_eq</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_steady_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">check_eq</span><span class="p">:</span>
                <span class="n">tol</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tol&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-8</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f0</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">x_eq</span><span class="p">,</span> <span class="n">z_eq</span><span class="p">,</span> <span class="n">u_eq</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span><span class="p">,</span> <span class="p">:])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ca</span><span class="o">.</span><span class="n">logic_all</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">f0</span><span class="o">.</span><span class="n">fabs</span><span class="p">(),</span> <span class="n">tol</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Supplied values are not an equilibrium point. Maximum error: &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">mmax</span><span class="p">(</span><span class="n">f0</span><span class="o">.</span><span class="n">fabs</span><span class="p">()))</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">g0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g0</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">x_eq</span><span class="p">,</span> <span class="n">z_eq</span><span class="p">,</span> <span class="n">u_eq</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_p</span><span class="p">,</span> <span class="p">:])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ca</span><span class="o">.</span><span class="n">logic_all</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">g0</span><span class="o">.</span><span class="n">fabs</span><span class="p">(),</span> <span class="n">tol</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Supplied values are not an equilibrium point. Maximum error: &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">ca</span><span class="o">.</span><span class="n">mmax</span><span class="p">(</span><span class="n">g0</span><span class="o">.</span><span class="n">fabs</span><span class="p">()))</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">x_eq</span><span class="p">,</span> <span class="n">z_eq</span><span class="p">,</span> <span class="n">u_eq</span><span class="p">)</span>

        <span class="c1"># NOTE: More often than not the rootfinder won&#39;t work with the latest values for the algebraic states stored</span>
        <span class="c1">#  in the solution object as initial conditions. Here, we enable to set the initial conditions of the rootfinder</span>
        <span class="c1">#  arbitrarily by the user.</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the algebraic states &#39;z&#39; is &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">z</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">z</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">z</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">!=</span> <span class="n">steps</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the algebraic states &#39;z&#39; is &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">z</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">z</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;z0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">x_col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x_col&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x_col</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x_col</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">size1</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the dynamical states at the &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;collocation points &#39;x_col&#39; is </span><span class="si">{</span><span class="n">x_col</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">x_col</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x_col</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">x_col</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">x_col</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">!=</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the dynamical states at the &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;collocation points &#39;x_col&#39; is </span><span class="si">{</span><span class="n">x_col</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">x_col</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_col</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;x_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_col</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;x_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collocation_points</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="n">z_col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;z_col&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">z_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">z_col</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">z_col</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">DM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">z_col</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">size1</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the algebraic states at the &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;collocation points &#39;z_col&#39; is </span><span class="si">{</span><span class="n">z_col</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">z_col</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">z_col</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">z_col</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">z_col</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">z_col</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span> <span class="o">!=</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimension mismatch. Supplied dimension for the algebraic states at the &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;collocation points &#39;z_col&#39; is </span><span class="si">{</span><span class="n">z_col</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">z_col</span><span class="o">.</span><span class="n">size2</span><span class="p">()</span><span class="si">}</span><span class="s2">, but required &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;dimension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_z_col</span><span class="o">.</span><span class="n">size1</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;z_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_col</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;z_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;z0&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collocation_points</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span><span class="o">.</span><span class="n">mapaccum</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;zf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;yf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_q</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;qf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">generate_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">signal_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="n">output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;absolute&#39;</span><span class="p">,</span>
            <span class="n">shift</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">add_noise</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">n_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">mean</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">variance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">chirps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Numeric</span><span class="p">]]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">skip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataSet</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param signal_type:</span>
<span class="sd">        :param args:</span>
<span class="sd">        :param output:</span>
<span class="sd">        :param shift:</span>
<span class="sd">        :param add_noise:</span>
<span class="sd">        :param n_samples:</span>
<span class="sd">        :param steps:</span>
<span class="sd">        :param bounds:</span>
<span class="sd">        :param mean:</span>
<span class="sd">        :param variance:</span>
<span class="sd">        :param seed:</span>
<span class="sd">        :param chirps:</span>
<span class="sd">        :param skip:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Support for algebraic states and parameters</span>
        <span class="n">data_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">signal_type</span> <span class="o">=</span> <span class="n">signal_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">signal_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;random_uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;random_normal&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">n_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating data using the </span><span class="si">{</span><span class="n">signal_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> signal requires &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;information about the number of samples by supplying the keyword &#39;n_samples&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating data using the </span><span class="si">{</span><span class="n">signal_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> signal requires &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;information about the number of steps by supplying the keyword &#39;steps&#39;&quot;</span><span class="p">)</span>

            <span class="n">lbs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ubs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lb</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lb&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">lb</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lower_bound&#39;</span><span class="p">)</span>
                    <span class="n">ub</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ub&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ub</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upper_bound&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lb</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">if</span> <span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ub</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="n">lbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>
                <span class="n">ubs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">signal_type</span> <span class="o">==</span> <span class="s1">&#39;random_uniform&#39;</span><span class="p">:</span>
                <span class="n">data_generator</span><span class="o">.</span><span class="n">random_uniform</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">lbs</span><span class="p">,</span> <span class="n">ubs</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># signal_type == &#39;random_normal&#39;</span>
                <span class="n">mus</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">sigmas</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                    <span class="n">mu</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">mu</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">mus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
                    <span class="n">sigma</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">variance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sigma</span> <span class="o">=</span> <span class="n">variance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">sigmas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_u</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">mus</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">mus</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ubs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">lbs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sigmas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">*</span> <span class="p">(</span><span class="n">ubs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">lbs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># 99.7% lie between lb and ub</span>

                <span class="n">data_generator</span><span class="o">.</span><span class="n">random_normal</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">mus</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">signal_type</span> <span class="o">==</span> <span class="s1">&#39;chirp&#39;</span><span class="p">:</span>
            <span class="n">types</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">amplitudes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">chirp_rates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">initial_phases</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">initial_frequencies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">initial_frequency_ratios</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_u</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">chirp</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chirp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">type_</span> <span class="o">=</span> <span class="n">chirp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">type_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">type_</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>
                    <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>

                    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">chirp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;amplitude&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">amplitude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">amplitude</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="n">amplitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>

                    <span class="n">length</span> <span class="o">=</span> <span class="n">chirp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No length(s) supplied for input &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>

                    <span class="n">mean</span> <span class="o">=</span> <span class="n">chirp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">mean</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>

                    <span class="n">chirp_rate</span> <span class="o">=</span> <span class="n">chirp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chirp_rate&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">chirp_rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No chirp rate(s) supplied for input &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="n">chirp_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chirp_rate</span><span class="p">)</span>

                    <span class="n">initial_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chirp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_phase&#39;</span><span class="p">))</span>
                    <span class="n">initial_frequencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chirp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_frequency&#39;</span><span class="p">))</span>
                    <span class="n">initial_frequency_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chirp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_frequency_ratio&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No chirp signals supplied for input&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="n">data_generator</span><span class="o">.</span><span class="n">chirp</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">chirp_rates</span><span class="p">,</span> <span class="n">initial_phase</span><span class="o">=</span><span class="n">initial_phases</span><span class="p">,</span>
                                 <span class="n">initial_frequency</span><span class="o">=</span><span class="n">initial_frequencies</span><span class="p">,</span>
                                 <span class="n">initial_frequency_ratio</span><span class="o">=</span><span class="n">initial_frequency_ratios</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">signal_type</span> <span class="o">==</span> <span class="s1">&#39;closed_loop&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No controller supplied for </span><span class="si">{</span><span class="n">signal_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> setup&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating data using the </span><span class="si">{</span><span class="n">signal_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> setup requires &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;information about the number of steps by supplying the keyword &#39;steps&#39;&quot;</span><span class="p">)</span>

            <span class="n">data_generator</span><span class="o">.</span><span class="n">closed_loop</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;seed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">add_noise</span> <span class="ow">and</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">add_noise</span> <span class="o">=</span> <span class="n">add_noise</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">add_noise</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed</span>

        <span class="k">if</span> <span class="n">skip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">):</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">skip</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mixed iterables for the keyword argument &#39;skip&#39; are not allowed. Either use only &quot;</span>
                                 <span class="s2">&quot;strings or only indices (integers) in your iterable.&quot;</span><span class="p">)</span>
        <span class="n">data_generator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">add_noise</span><span class="o">=</span><span class="n">add_noise</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data_generator</span><span class="o">.</span><span class="n">data</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, Johannes Pohlodek, Bruno Morabito.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️  using a custom <a href="https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'1.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../../_static/sphinx_highlight.js"></script>
      <script type="text/javascript" src="../../../../_static/clipboard.min.js"></script>
      <script type="text/javascript" src="../../../../_static/copybutton.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>